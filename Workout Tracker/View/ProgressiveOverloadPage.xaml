<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Workout_Tracker.ViewModel"
             xmlns:model="clr-namespace:Workout_Tracker.Model"
             x:Class="Workout_Tracker.View.ProgressiveOverloadPage"
             x:DataType="vm:ProgressiveOverloadViewModel"
             BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource OffBlack}}"
             Shell.NavBarIsVisible="False">

    <Grid RowDefinitions="Auto,*">

        <!-- Header -->
        <Grid Padding="14,16,14,0" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="0">
            <Label Text="Back"
                   FontSize="15"
                   TextColor="{StaticResource Primary}"
                   VerticalOptions="Center">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding BackCommand}" />
                </Label.GestureRecognizers>
            </Label>
            <Label Grid.Column="1"
                   Text="Progressive Overload"
                   FontSize="17"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center"
                   VerticalOptions="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
            <Label Grid.Column="2"
                   Text="Generate"
                   FontSize="15"
                   FontAttributes="Bold"
                   TextColor="{StaticResource Primary}"
                   Opacity="{Binding HasPreview, Converter={StaticResource BoolToOpacityConverter}}"
                   VerticalOptions="Center">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding GenerateCommand}" />
                </Label.GestureRecognizers>
            </Label>
        </Grid>

        <!-- Content -->
        <ScrollView Grid.Row="1" Padding="14,12,14,16">
            <VerticalStackLayout Spacing="14">

                <!-- ═══ Per-Session Config Cards ═══ -->
                <VerticalStackLayout BindableLayout.ItemsSource="{Binding SessionConfigs}"
                                     Spacing="14">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="model:SessionOverloadConfig">
                            <Border StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                    Padding="12"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource CardBackground}}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="10">

                                    <!-- Session Header -->
                                    <Label Text="{Binding SessionLabel}"
                                           FontSize="15"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />

                                    <!-- Method Chips — compact, fits one row -->
                                    <FlexLayout Wrap="Wrap"
                                                JustifyContent="Start"
                                                BindableLayout.ItemsSource="{Binding MethodChips}">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="model:MethodChipItem">
                                                <Border StrokeThickness="1"
                                                        Padding="10,6"
                                                        Margin="0,0,6,0"
                                                        BackgroundColor="Transparent">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="8" />
                                                    </Border.StrokeShape>
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding SelectCommand}" />
                                                    </Border.GestureRecognizers>
                                                    <Border.Triggers>
                                                        <DataTrigger TargetType="Border"
                                                                     Binding="{Binding IsSelected}"
                                                                     Value="True">
                                                            <Setter Property="Stroke" Value="{StaticResource Primary}" />
                                                            <Setter Property="BackgroundColor" Value="{StaticResource Primary}" />
                                                        </DataTrigger>
                                                        <DataTrigger TargetType="Border"
                                                                     Binding="{Binding IsSelected}"
                                                                     Value="False">
                                                            <Setter Property="Stroke" Value="{AppThemeBinding Light=#D1D5DB, Dark=#444444}" />
                                                            <Setter Property="BackgroundColor" Value="Transparent" />
                                                        </DataTrigger>
                                                    </Border.Triggers>
                                                    <Label Text="{Binding Label}"
                                                           FontSize="13">
                                                        <Label.Triggers>
                                                            <DataTrigger TargetType="Label"
                                                                         Binding="{Binding IsSelected}"
                                                                         Value="True">
                                                                <Setter Property="TextColor" Value="White" />
                                                                <Setter Property="FontAttributes" Value="Bold" />
                                                            </DataTrigger>
                                                            <DataTrigger TargetType="Label"
                                                                         Binding="{Binding IsSelected}"
                                                                         Value="False">
                                                                <Setter Property="TextColor" Value="{AppThemeBinding Light=#374151, Dark={StaticResource White}}" />
                                                                <Setter Property="FontAttributes" Value="None" />
                                                            </DataTrigger>
                                                        </Label.Triggers>
                                                    </Label>
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </FlexLayout>

                                    <!-- Weight Increment — flat rows, no per-exercise borders -->
                                    <VerticalStackLayout Spacing="8"
                                                         IsVisible="{Binding ShowWeightIncrement}">
                                        <Label Text="WEIGHT PER CYCLE"
                                               FontSize="10"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                               CharacterSpacing="1" />
                                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding Exercises}"
                                                             Spacing="8">
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate x:DataType="model:ExerciseOverloadConfig">
                                                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                                                        <VerticalStackLayout Spacing="1" VerticalOptions="Center">
                                                            <Label Text="{Binding ExerciseName}"
                                                                   FontSize="13"
                                                                   FontAttributes="Bold"
                                                                   LineBreakMode="TailTruncation"
                                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                                            <Label Text="{Binding BaseInfoDisplay}"
                                                                   FontSize="11"
                                                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                        </VerticalStackLayout>
                                                        <Border Grid.Column="1"
                                                                StrokeThickness="1"
                                                                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                                                Padding="6,3"
                                                                WidthRequest="56"
                                                                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark=#252525}">
                                                            <Border.StrokeShape>
                                                                <RoundRectangle CornerRadius="6" />
                                                            </Border.StrokeShape>
                                                            <Entry Text="{Binding IncrementText}"
                                                                   Keyboard="Numeric"
                                                                   FontSize="13"
                                                                   HorizontalTextAlignment="Center"
                                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                                        </Border>
                                                        <Label Grid.Column="2"
                                                               Text="kg"
                                                               FontSize="12"
                                                               VerticalOptions="Center"
                                                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                    </Grid>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>

                                    <!-- Volume — compact inline layout -->
                                    <VerticalStackLayout Spacing="8"
                                                         IsVisible="{Binding ShowVolumeConfig}">
                                        <Label Text="VOLUME PER EXERCISE"
                                               FontSize="10"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                               CharacterSpacing="1" />
                                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding Exercises}"
                                                             Spacing="8">
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate x:DataType="model:ExerciseOverloadConfig">
                                                    <VerticalStackLayout Spacing="4">
                                                        <Label Text="{Binding ExerciseName}"
                                                               FontSize="13"
                                                               FontAttributes="Bold"
                                                               LineBreakMode="TailTruncation"
                                                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                                        <HorizontalStackLayout Spacing="5" VerticalOptions="Center">
                                                            <Label Text="+"
                                                                   FontSize="12"
                                                                   VerticalOptions="Center"
                                                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                            <Border StrokeThickness="1"
                                                                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                                                    Padding="6,3"
                                                                    WidthRequest="40"
                                                                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark=#252525}">
                                                                <Border.StrokeShape>
                                                                    <RoundRectangle CornerRadius="6" />
                                                                </Border.StrokeShape>
                                                                <Entry Text="{Binding SetsToAddText}"
                                                                       Keyboard="Numeric"
                                                                       FontSize="13"
                                                                       HorizontalTextAlignment="Center"
                                                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                                            </Border>
                                                            <Label Text="sets every"
                                                                   FontSize="12"
                                                                   VerticalOptions="Center"
                                                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                            <Border StrokeThickness="1"
                                                                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                                                    Padding="6,3"
                                                                    WidthRequest="40"
                                                                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark=#252525}">
                                                                <Border.StrokeShape>
                                                                    <RoundRectangle CornerRadius="6" />
                                                                </Border.StrokeShape>
                                                                <Entry Text="{Binding EveryNCyclesText}"
                                                                       Keyboard="Numeric"
                                                                       FontSize="13"
                                                                       HorizontalTextAlignment="Center"
                                                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                                            </Border>
                                                            <Label Text="cycles"
                                                                   FontSize="12"
                                                                   VerticalOptions="Center"
                                                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                        </HorizontalStackLayout>
                                                    </VerticalStackLayout>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>

                                    <!-- Double Progression Cycles -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10"
                                          IsVisible="{Binding ShowDoubleProgressionCycles}">
                                        <Label Text="Cycles before weight jump"
                                               FontSize="13"
                                               VerticalOptions="Center"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                        <Border Grid.Column="1"
                                                StrokeThickness="1"
                                                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                                Padding="6,3" WidthRequest="56"
                                                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark=#252525}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="6" />
                                            </Border.StrokeShape>
                                            <Entry Text="{Binding DoubleProgressionCyclesText}"
                                                   Keyboard="Numeric" FontSize="13"
                                                   HorizontalTextAlignment="Center"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                        </Border>
                                    </Grid>

                                    <!-- RPE Increment -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10"
                                          IsVisible="{Binding ShowRpeIncrement}">
                                        <Label Text="RPE increase per cycle"
                                               FontSize="13"
                                               VerticalOptions="Center"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                        <Border Grid.Column="1"
                                                StrokeThickness="1"
                                                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                                Padding="6,3" WidthRequest="56"
                                                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark=#252525}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="6" />
                                            </Border.StrokeShape>
                                            <Entry Text="{Binding RpeIncrementText}"
                                                   Keyboard="Numeric" FontSize="13"
                                                   HorizontalTextAlignment="Center"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                        </Border>
                                    </Grid>

                                    <!-- Step Cycles -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10"
                                          IsVisible="{Binding ShowStepCycles}">
                                        <Label Text="Increase every N cycles"
                                               FontSize="13"
                                               VerticalOptions="Center"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                        <Border Grid.Column="1"
                                                StrokeThickness="1"
                                                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                                Padding="6,3" WidthRequest="56"
                                                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark=#252525}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="6" />
                                            </Border.StrokeShape>
                                            <Entry Text="{Binding StepCyclesText}"
                                                   Keyboard="Numeric" FontSize="13"
                                                   HorizontalTextAlignment="Center"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                        </Border>
                                    </Grid>

                                    <!-- Include Base Cycle -->
                                    <HorizontalStackLayout Spacing="8"
                                                           IsVisible="{Binding ShowIncludeBaseCycle}">
                                        <CheckBox IsChecked="{Binding IncludeBaseCycle}"
                                                  Color="{StaticResource Primary}"
                                                  VerticalOptions="Center" />
                                        <Label Text="Include base cycle in count"
                                               FontSize="13"
                                               VerticalOptions="Center"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                    </HorizontalStackLayout>

                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

                <!-- ═══ Cycle Count ═══ -->
                <Border StrokeThickness="1"
                        Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                        BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource CardBackground}}"
                        Padding="12">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                            <Label Text="Cycles"
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                            <Label FontSize="11"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}">
                                <Label.Text>
                                    <MultiBinding StringFormat="{}{0} x {1} = {2} sessions">
                                        <Binding Path="CycleCount" />
                                        <Binding Path="BaseSessionCount" />
                                        <Binding Path="TotalSessionsToGenerate" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                        </VerticalStackLayout>
                        <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                            <Border StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                    Padding="10,6"
                                    BackgroundColor="Transparent">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnDecrementCycles" />
                                </Border.GestureRecognizers>
                                <Label Text="-"
                                       FontSize="18" FontAttributes="Bold"
                                       HorizontalTextAlignment="Center" WidthRequest="24"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                            </Border>
                            <Label Text="{Binding CycleCount}"
                                   FontSize="20" FontAttributes="Bold"
                                   WidthRequest="30" HorizontalTextAlignment="Center"
                                   VerticalOptions="Center"
                                   TextColor="{StaticResource Primary}" />
                            <Border StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                    Padding="10,6"
                                    BackgroundColor="Transparent">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnIncrementCycles" />
                                </Border.GestureRecognizers>
                                <Label Text="+"
                                       FontSize="18" FontAttributes="Bold"
                                       HorizontalTextAlignment="Center" WidthRequest="24"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                            </Border>
                        </HorizontalStackLayout>
                    </Grid>
                </Border>

                <!-- ═══ Preview Button ═══ -->
                <Button Text="Preview"
                        Command="{Binding GeneratePreviewCommand}"
                        BackgroundColor="Transparent"
                        BorderColor="{StaticResource Primary}"
                        BorderWidth="1.5"
                        TextColor="{StaticResource Primary}"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="44" />

                <!-- ═══ Preview Results ═══ -->
                <VerticalStackLayout Spacing="8"
                                     IsVisible="{Binding HasPreview}">
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="PREVIEW"
                               FontSize="10"
                               VerticalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                               CharacterSpacing="1" />
                        <Label Grid.Column="1"
                               FontSize="11"
                               VerticalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}">
                            <Label.Text>
                                <Binding Path="TotalSessionsToGenerate"
                                         StringFormat="{}{0} new sessions" />
                            </Label.Text>
                        </Label>
                    </Grid>

                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding Preview}"
                                         Spacing="8">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="model:OverloadPreviewCycle">
                                <Border StrokeThickness="1"
                                        Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                        Padding="12,10"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource CardBackground}}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10" />
                                    </Border.StrokeShape>
                                    <VerticalStackLayout Spacing="6">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Text="{Binding WeekLabel}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                            <Label Grid.Column="1"
                                                   Text="{Binding SessionCount, StringFormat='{0} sessions'}"
                                                   FontSize="11"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                                   VerticalOptions="Center" />
                                        </Grid>
                                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding Exercises}"
                                                             Spacing="4">
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate x:DataType="model:OverloadPreviewExercise">
                                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                        <VerticalStackLayout Spacing="0">
                                                            <Label Text="{Binding ExerciseName}"
                                                                   FontSize="13"
                                                                   FontAttributes="Bold"
                                                                   LineBreakMode="TailTruncation"
                                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                                            <HorizontalStackLayout Spacing="6">
                                                                <Label Text="{Binding SetsRepsDisplay}"
                                                                       FontSize="11"
                                                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                                <Label Text="{Binding WeightDisplay}"
                                                                       FontSize="11"
                                                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                                <Label Text="{Binding RpeDisplay}"
                                                                       FontSize="11"
                                                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                            </HorizontalStackLayout>
                                                        </VerticalStackLayout>
                                                        <Label Grid.Column="1"
                                                               Text="{Binding ChangeNote}"
                                                               FontSize="12"
                                                               FontAttributes="Bold"
                                                               VerticalOptions="Center"
                                                               TextColor="{StaticResource Primary}" />
                                                    </Grid>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

    </Grid>

</ContentPage>
